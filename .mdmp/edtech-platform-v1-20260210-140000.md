# MDMP Orders: EdTech Learning Platform V1

**Classification:** STRATEGIC
**Created:** 2026-02-10 14:00
**Status:** IN PROGRESS

---

## Mission Statement

Build a full-featured EdTech learning platform (20 features) for a client education company using Next.js + Supabase, with domain-driven modular architecture that is mobile-ready for future Expo (React Native) deployment.

## Commander's Intent

A polished V1 that replaces Canvas as the student-facing experience, provides a unified admin dashboard aggregating progress from Coursera/Pluralsight/Udemy, and creates a community for student engagement. Architecture must support future SaaS multi-tenancy and mobile app extraction with zero logic rewrites.

---

## Decision Log

**Selected:** COA 2 - Domain-Driven Modular Monolith + Expo Mobile Strategy

**Rationale:**
Single Next.js deployment with strict internal domain boundaries. Business logic in `lib/` is platform-agnostic for future Expo extraction. API routes serve as the mobile-accessible interface. Multi-tenant schema from day one.

**Rejected Alternatives:**
- COA 1 (Flat Monolith): Would become unmaintainable at 20 features, no SaaS extraction path
- COA 3 (Turborepo Multi-App): Over-engineered for V1, adds weeks of infrastructure without shipping features

---

## Tech Stack

| Layer | Technology | Purpose |
|-------|-----------|---------|
| Framework | Next.js 15 (App Router) | Web application |
| Database | Supabase Postgres | Data layer with RLS |
| Auth | Supabase Auth | Authentication + session management |
| Storage | Supabase Storage | Files, images, thumbnails |
| Real-time | Supabase Realtime | Discussions, notifications |
| UI | Tailwind CSS + shadcn/ui | Component library |
| Rich Text | Tiptap (ProseMirror) | Lesson content editor |
| Hosting | Vercel (VetSecItPro team) | Deployment + CDN |
| Future Mobile | Expo (React Native) + EAS Build | iOS + Android apps |

---

## Project Structure

```
vetsintech/
├── app/                                # WEB-ONLY routes
│   ├── (auth)/                         # Auth pages (login, register, forgot-password)
│   │   ├── login/page.tsx
│   │   ├── register/page.tsx
│   │   └── forgot-password/page.tsx
│   ├── (student)/                      # Student-facing routes (requires student/instructor role)
│   │   ├── layout.tsx                  #   Student layout (top nav, sidebar)
│   │   ├── dashboard/page.tsx          #   Student dashboard
│   │   ├── courses/                    #   Course catalog + enrollment
│   │   │   ├── page.tsx               #     Browse available courses
│   │   │   └── [courseId]/            #     Course detail + player
│   │   │       ├── page.tsx           #       Course overview
│   │   │       └── lessons/
│   │   │           └── [lessonId]/
│   │   │               └── page.tsx   #       Lesson player
│   │   ├── community/                  #   Discussion boards
│   │   │   ├── page.tsx               #     All discussions
│   │   │   └── [threadId]/page.tsx    #     Thread detail
│   │   ├── profile/page.tsx            #   Student profile
│   │   └── notifications/page.tsx      #   Notification center
│   ├── (admin)/                        # Admin routes (requires admin role)
│   │   ├── layout.tsx                  #   Admin layout (sidebar nav)
│   │   ├── dashboard/page.tsx          #   Admin analytics dashboard
│   │   ├── courses/                    #   Course management
│   │   │   ├── page.tsx               #     Course list
│   │   │   ├── new/page.tsx           #     Create course
│   │   │   └── [courseId]/
│   │   │       ├── edit/page.tsx      #     Edit course
│   │   │       ├── modules/page.tsx   #     Module management
│   │   │       └── lessons/
│   │   │           └── [lessonId]/
│   │   │               └── edit/page.tsx  # Lesson editor
│   │   ├── cohorts/                    #   Cohort management
│   │   │   ├── page.tsx               #     Cohort list
│   │   │   ├── new/page.tsx           #     Create cohort (clone course)
│   │   │   └── [cohortId]/page.tsx    #     Cohort detail + enrollments
│   │   ├── students/                   #   Student management
│   │   │   ├── page.tsx               #     Student roster
│   │   │   ├── new/page.tsx           #     Add student
│   │   │   └── [studentId]/page.tsx   #     Student detail + progress
│   │   ├── integrations/              #   External platform management
│   │   │   └── page.tsx               #     Coursera/Pluralsight/Udemy config + progress
│   │   ├── announcements/             #   Announcement management
│   │   │   ├── page.tsx               #     List
│   │   │   └── new/page.tsx           #     Create announcement
│   │   ├── discussions/page.tsx        #   Discussion moderation
│   │   └── settings/page.tsx           #   Organization settings
│   ├── api/                            # API routes (MOBILE-ACCESSIBLE)
│   │   ├── auth/                       #   Auth endpoints
│   │   ├── courses/                    #   Course CRUD
│   │   ├── lessons/                    #   Lesson CRUD + completion
│   │   ├── modules/                    #   Module CRUD + ordering
│   │   ├── cohorts/                    #   Cohort CRUD + enrollment
│   │   ├── quizzes/                    #   Quiz CRUD + submissions
│   │   ├── discussions/                #   Discussion CRUD + reactions
│   │   ├── announcements/              #   Announcement CRUD
│   │   ├── notifications/              #   Notification endpoints
│   │   ├── progress/                   #   Progress tracking endpoints
│   │   ├── certificates/               #   Certificate generation
│   │   ├── integrations/               #   External platform sync
│   │   ├── students/                   #   Student management
│   │   ├── files/                      #   File upload/management
│   │   └── admin/                      #   Admin analytics
│   ├── layout.tsx                      # Root layout
│   └── page.tsx                        # Landing/redirect
│
├── components/                         # WEB-ONLY UI components
│   ├── ui/                             #   shadcn/ui primitives (button, card, dialog, etc.)
│   ├── layout/                         #   Navigation, sidebar, header, footer
│   ├── courses/                        #   Course cards, module tree, lesson viewer
│   ├── editor/                         #   Tiptap editor + toolbar
│   ├── community/                      #   Discussion thread, post card, reply form
│   ├── quizzes/                        #   Quiz player, question types, results
│   ├── admin/                          #   Charts, data tables, analytics cards
│   ├── certificates/                   #   Certificate template/preview
│   └── shared/                         #   Loading states, empty states, error boundaries
│
├── lib/                                # PLATFORM-AGNOSTIC (shareable with future Expo app)
│   ├── domains/                        #   Business logic by domain
│   │   ├── courses/
│   │   │   ├── types.ts               #     Course, Module, Lesson interfaces
│   │   │   ├── queries.ts             #     Supabase SELECT queries
│   │   │   ├── mutations.ts           #     Supabase INSERT/UPDATE/DELETE
│   │   │   └── utils.ts              #     Pure functions (ordering, validation)
│   │   ├── progress/
│   │   │   ├── types.ts               #     Progress, Completion interfaces
│   │   │   ├── queries.ts
│   │   │   ├── mutations.ts
│   │   │   └── utils.ts              #     Progress calculation, streak logic
│   │   ├── quizzes/
│   │   │   ├── types.ts               #     Quiz, Question, Attempt interfaces
│   │   │   ├── queries.ts
│   │   │   ├── mutations.ts
│   │   │   └── utils.ts              #     Auto-grading logic, scoring
│   │   ├── community/
│   │   │   ├── types.ts               #     Discussion, Post, Reaction interfaces
│   │   │   ├── queries.ts
│   │   │   ├── mutations.ts
│   │   │   └── utils.ts
│   │   ├── notifications/
│   │   │   ├── types.ts
│   │   │   ├── queries.ts
│   │   │   └── mutations.ts
│   │   ├── certificates/
│   │   │   ├── types.ts
│   │   │   ├── queries.ts
│   │   │   ├── mutations.ts
│   │   │   └── utils.ts              #     Certificate generation logic
│   │   ├── admin/
│   │   │   ├── types.ts               #     Analytics, StudentManagement interfaces
│   │   │   ├── queries.ts            #     Aggregate queries, reports
│   │   │   └── utils.ts              #     Stats calculations
│   │   └── integrations/
│   │       ├── types.ts               #     Shared integration interfaces
│   │       ├── adapter.ts             #     Provider adapter interface
│   │       ├── coursera/
│   │       │   ├── client.ts          #     Coursera OAuth2 client
│   │       │   ├── adapter.ts         #     Coursera adapter implementation
│   │       │   └── types.ts           #     Coursera-specific types
│   │       ├── pluralsight/
│   │       │   ├── client.ts          #     Pluralsight GraphQL client
│   │       │   ├── adapter.ts
│   │       │   └── types.ts
│   │       └── udemy/
│   │           ├── client.ts          #     Udemy REST client
│   │           ├── adapter.ts
│   │           └── types.ts
│   ├── supabase/
│   │   ├── client.ts                  #   Browser client
│   │   ├── server.ts                  #   Server client (Next.js specific)
│   │   ├── middleware.ts              #   Auth middleware
│   │   ├── admin.ts                   #   Service role client (admin operations)
│   │   └── database.types.ts          #   Auto-generated types from schema
│   ├── types/
│   │   ├── index.ts                   #   Global type exports
│   │   ├── auth.ts                    #   Auth/role types
│   │   └── common.ts                 #   Shared utility types (Pagination, ApiResponse, etc.)
│   ├── utils/
│   │   ├── dates.ts                   #   Date formatting
│   │   ├── validation.ts             #   Zod schemas for form validation
│   │   └── formatting.ts             #   Text/number formatting
│   └── constants/
│       ├── roles.ts                   #   Role definitions
│       ├── platforms.ts               #   External platform identifiers
│       └── routes.ts                  #   Route constants
│
├── supabase/                           # DATABASE
│   ├── migrations/                     #   Versioned SQL migrations
│   │   ├── 00001_organizations.sql
│   │   ├── 00002_profiles_and_roles.sql
│   │   ├── 00003_courses_modules_lessons.sql
│   │   ├── 00004_cohorts_enrollments.sql
│   │   ├── 00005_progress_tracking.sql
│   │   ├── 00006_quizzes.sql
│   │   ├── 00007_discussions.sql
│   │   ├── 00008_announcements_notifications.sql
│   │   ├── 00009_certificates.sql
│   │   ├── 00010_external_integrations.sql
│   │   ├── 00011_file_library.sql
│   │   ├── 00012_rls_policies.sql
│   │   └── 00013_seed_data.sql
│   └── config.toml
│
├── public/                             # Static assets
│   ├── images/
│   └── fonts/
│
├── .env.local                          # Environment variables (gitignored)
├── .env.example                        # Template for env vars
├── .gitignore
├── next.config.ts
├── tailwind.config.ts
├── tsconfig.json
├── package.json
├── middleware.ts                        # Next.js middleware (auth + role routing)
└── .mdmp/                              # This planning directory
```

---

## Database Schema

### Core Tables

```sql
-- 00001: Organizations (multi-tenant ready)
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    slug TEXT NOT NULL UNIQUE,
    logo_url TEXT,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- 00002: Profiles & Roles
CREATE TABLE profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    organization_id UUID NOT NULL REFERENCES organizations(id),
    email TEXT NOT NULL,
    full_name TEXT NOT NULL,
    avatar_url TEXT,
    bio TEXT,
    phone TEXT,
    timezone TEXT DEFAULT 'America/New_York',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TYPE user_role AS ENUM ('admin', 'instructor', 'student');

CREATE TABLE user_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    organization_id UUID NOT NULL REFERENCES organizations(id),
    role user_role NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(user_id, organization_id, role)
);
```

### Course Tables

```sql
-- 00003: Courses, Modules, Lessons
CREATE TABLE courses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    title TEXT NOT NULL,
    slug TEXT NOT NULL,
    description TEXT,
    thumbnail_url TEXT,
    category TEXT,
    tags JSONB DEFAULT '[]',
    prerequisites JSONB DEFAULT '[]',
    status TEXT NOT NULL DEFAULT 'draft',  -- draft, published, archived
    created_by UUID REFERENCES profiles(id),
    estimated_duration_minutes INTEGER,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(organization_id, slug)
);

CREATE TABLE modules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    course_id UUID NOT NULL REFERENCES courses(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    sort_order INTEGER NOT NULL DEFAULT 0,
    is_required BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TYPE lesson_type AS ENUM ('text', 'video', 'quiz', 'assignment', 'resource');

CREATE TABLE lessons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    module_id UUID NOT NULL REFERENCES modules(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    lesson_type lesson_type NOT NULL DEFAULT 'text',
    content JSONB,               -- Tiptap ProseMirror JSON
    video_url TEXT,              -- YouTube/Vimeo embed URL
    sort_order INTEGER NOT NULL DEFAULT 0,
    estimated_duration_minutes INTEGER,
    is_required BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);
```

### Cohort & Enrollment Tables

```sql
-- 00004: Cohorts & Enrollments
CREATE TABLE cohorts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    course_id UUID NOT NULL REFERENCES courses(id),
    name TEXT NOT NULL,                  -- e.g., "Spring 2026 Cohort"
    description TEXT,
    status TEXT NOT NULL DEFAULT 'active', -- active, completed, archived
    starts_at TIMESTAMPTZ,
    ends_at TIMESTAMPTZ,
    max_students INTEGER,
    cloned_from UUID REFERENCES cohorts(id),  -- Track cloning lineage
    created_by UUID REFERENCES profiles(id),
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE enrollments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    cohort_id UUID NOT NULL REFERENCES cohorts(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    enrolled_at TIMESTAMPTZ DEFAULT now(),
    enrolled_by UUID REFERENCES profiles(id), -- Admin who enrolled them
    status TEXT NOT NULL DEFAULT 'active',     -- active, completed, dropped, suspended
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(cohort_id, user_id)
);
```

### Progress Tables

```sql
-- 00005: Progress Tracking
CREATE TABLE lesson_completions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    lesson_id UUID NOT NULL REFERENCES lessons(id) ON DELETE CASCADE,
    cohort_id UUID NOT NULL REFERENCES cohorts(id) ON DELETE CASCADE,
    completed_at TIMESTAMPTZ DEFAULT now(),
    time_spent_seconds INTEGER DEFAULT 0,
    UNIQUE(user_id, lesson_id, cohort_id)
);

-- Materialized/computed progress (updated via triggers or on-read)
CREATE TABLE course_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    cohort_id UUID NOT NULL REFERENCES cohorts(id) ON DELETE CASCADE,
    course_id UUID NOT NULL REFERENCES courses(id) ON DELETE CASCADE,
    total_lessons INTEGER NOT NULL DEFAULT 0,
    completed_lessons INTEGER NOT NULL DEFAULT 0,
    progress_percentage DECIMAL(5,2) NOT NULL DEFAULT 0.00,
    last_lesson_id UUID REFERENCES lessons(id),
    last_activity_at TIMESTAMPTZ,
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    updated_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(user_id, cohort_id)
);
```

### Quiz Tables

```sql
-- 00006: Quizzes & Assessments
CREATE TABLE quizzes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lesson_id UUID NOT NULL REFERENCES lessons(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    passing_score DECIMAL(5,2) NOT NULL DEFAULT 70.00,
    max_attempts INTEGER DEFAULT 3,           -- null = unlimited
    time_limit_minutes INTEGER,               -- null = no limit
    shuffle_questions BOOLEAN DEFAULT false,
    show_correct_answers BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TYPE question_type AS ENUM ('multiple_choice', 'true_false', 'short_answer');

CREATE TABLE quiz_questions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    quiz_id UUID NOT NULL REFERENCES quizzes(id) ON DELETE CASCADE,
    question_text TEXT NOT NULL,
    question_type question_type NOT NULL,
    points DECIMAL(5,2) NOT NULL DEFAULT 1.00,
    sort_order INTEGER NOT NULL DEFAULT 0,
    explanation TEXT,                          -- Shown after answering
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE quiz_options (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    question_id UUID NOT NULL REFERENCES quiz_questions(id) ON DELETE CASCADE,
    option_text TEXT NOT NULL,
    is_correct BOOLEAN NOT NULL DEFAULT false,
    sort_order INTEGER NOT NULL DEFAULT 0
);

CREATE TABLE quiz_attempts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    quiz_id UUID NOT NULL REFERENCES quizzes(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    cohort_id UUID NOT NULL REFERENCES cohorts(id) ON DELETE CASCADE,
    score DECIMAL(5,2),
    passed BOOLEAN,
    started_at TIMESTAMPTZ DEFAULT now(),
    completed_at TIMESTAMPTZ,
    time_spent_seconds INTEGER
);

CREATE TABLE quiz_answers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    attempt_id UUID NOT NULL REFERENCES quiz_attempts(id) ON DELETE CASCADE,
    question_id UUID NOT NULL REFERENCES quiz_questions(id),
    selected_option_id UUID REFERENCES quiz_options(id),
    text_answer TEXT,                          -- For short_answer type
    is_correct BOOLEAN,
    points_earned DECIMAL(5,2) DEFAULT 0
);
```

### Community Tables

```sql
-- 00007: Discussions
CREATE TABLE discussions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    cohort_id UUID REFERENCES cohorts(id),    -- null = global/org-wide discussion
    title TEXT NOT NULL,
    body JSONB,                                -- Tiptap JSON for rich text
    author_id UUID NOT NULL REFERENCES profiles(id),
    is_pinned BOOLEAN DEFAULT false,
    is_locked BOOLEAN DEFAULT false,
    reply_count INTEGER DEFAULT 0,
    last_reply_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE discussion_posts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    discussion_id UUID NOT NULL REFERENCES discussions(id) ON DELETE CASCADE,
    parent_post_id UUID REFERENCES discussion_posts(id),  -- For nested replies
    author_id UUID NOT NULL REFERENCES profiles(id),
    body JSONB NOT NULL,                       -- Tiptap JSON
    upvote_count INTEGER DEFAULT 0,
    is_answer BOOLEAN DEFAULT false,           -- Marked as accepted answer
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE post_reactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    post_id UUID NOT NULL REFERENCES discussion_posts(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    reaction_type TEXT NOT NULL DEFAULT 'upvote',
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(post_id, user_id, reaction_type)
);
```

### Communication Tables

```sql
-- 00008: Announcements & Notifications
CREATE TABLE announcements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    cohort_id UUID REFERENCES cohorts(id),    -- null = org-wide
    title TEXT NOT NULL,
    body JSONB NOT NULL,                       -- Tiptap JSON
    author_id UUID NOT NULL REFERENCES profiles(id),
    is_published BOOLEAN DEFAULT false,
    published_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TYPE notification_type AS ENUM (
    'announcement', 'discussion_reply', 'quiz_graded',
    'enrollment', 'course_completed', 'certificate_issued',
    'mention', 'cohort_update'
);

CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    organization_id UUID NOT NULL REFERENCES organizations(id),
    type notification_type NOT NULL,
    title TEXT NOT NULL,
    body TEXT,
    link TEXT,                                 -- Deep link to relevant page
    is_read BOOLEAN DEFAULT false,
    read_at TIMESTAMPTZ,
    metadata JSONB DEFAULT '{}',               -- Type-specific data
    created_at TIMESTAMPTZ DEFAULT now()
);
```

### Certificate Tables

```sql
-- 00009: Certificates
CREATE TABLE certificates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    user_id UUID NOT NULL REFERENCES profiles(id),
    cohort_id UUID NOT NULL REFERENCES cohorts(id),
    course_id UUID NOT NULL REFERENCES courses(id),
    certificate_number TEXT NOT NULL UNIQUE,    -- Human-readable ID
    issued_at TIMESTAMPTZ DEFAULT now(),
    pdf_url TEXT,                               -- Stored in Supabase Storage
    metadata JSONB DEFAULT '{}',               -- Course title, instructor, etc. at time of issue
    created_at TIMESTAMPTZ DEFAULT now()
);
```

### External Integration Tables

```sql
-- 00010: External Platform Integrations
CREATE TYPE external_platform AS ENUM ('coursera', 'pluralsight', 'udemy');

CREATE TABLE external_platform_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    platform external_platform NOT NULL,
    is_enabled BOOLEAN DEFAULT false,
    credentials JSONB NOT NULL DEFAULT '{}',    -- Encrypted API keys/tokens
    sync_frequency_minutes INTEGER DEFAULT 1440, -- Default: daily
    last_synced_at TIMESTAMPTZ,
    sync_status TEXT DEFAULT 'idle',            -- idle, syncing, error
    sync_error TEXT,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(organization_id, platform)
);

CREATE TABLE external_enrollments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    user_id UUID NOT NULL REFERENCES profiles(id),
    platform external_platform NOT NULL,
    external_course_id TEXT NOT NULL,
    external_course_title TEXT NOT NULL,
    enrolled_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(user_id, platform, external_course_id)
);

CREATE TABLE external_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    external_enrollment_id UUID NOT NULL REFERENCES external_enrollments(id) ON DELETE CASCADE,
    progress_percentage DECIMAL(5,2) DEFAULT 0.00,
    status TEXT NOT NULL DEFAULT 'in_progress', -- in_progress, completed
    completed_at TIMESTAMPTZ,
    time_spent_minutes INTEGER,
    last_activity_at TIMESTAMPTZ,
    raw_data JSONB DEFAULT '{}',               -- Platform-specific raw response
    synced_at TIMESTAMPTZ DEFAULT now(),
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);
```

### File Library Table

```sql
-- 00011: File & Media Library
CREATE TABLE course_files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    course_id UUID REFERENCES courses(id),     -- null = org-level file
    uploaded_by UUID NOT NULL REFERENCES profiles(id),
    file_name TEXT NOT NULL,
    file_type TEXT NOT NULL,                   -- MIME type
    file_size INTEGER NOT NULL,                -- Bytes
    storage_path TEXT NOT NULL,                -- Supabase Storage path
    thumbnail_url TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);
```

---

## Assumptions & Constraints

### Assumptions
- [ ] Company has or can obtain API access for Coursera (Business/Campus plan)
- [ ] Company has or can obtain API access for Pluralsight (Business plan)
- [ ] Company has or can obtain API access for Udemy (Enterprise plan)
- [ ] V1 student count is hundreds, not tens of thousands
- [ ] Video content is hosted externally (YouTube/Vimeo), not self-hosted
- [ ] Single organization for V1 (schema supports multi-tenant)

### Constraints
- Deploy to Vercel under VetSecItPro team (team_HFUTBVxI8jKYi334LvgVsVNh)
- Supabase project isolated from existing tables (Rowan, sm_content, etc.)
- All business logic in lib/ must be platform-agnostic (no React DOM, no Next.js-specific imports)
- Every mutation must have both a server action (web) AND an API route (future mobile)
- organization_id on every table from day one

---

## Risk Register

| ID | Risk | Likelihood | Impact | Mitigation |
|----|------|:---:|:---:|------------|
| R1 | External platform APIs unavailable (wrong plan tier) | Medium | Medium | Build integration UI with graceful "not configured" state; CSV import fallback |
| R2 | Tiptap editor complexity for non-technical admins | Low | Medium | Provide formatting toolbar with common options; preview mode |
| R3 | RLS policy gaps expose data cross-tenant | Low | Critical | Dedicated RLS test suite; security audit before launch |
| R4 | Cohort cloning with large courses is slow | Low | Low | Clone asynchronously with progress indicator; optimize with bulk INSERT |
| R5 | Discussion boards become spam/noise | Medium | Low | Moderation tools, pin/lock, rate limiting on post creation |
| R6 | Quiz grading edge cases | Medium | Medium | Comprehensive unit tests for grading logic; manual override option |
| R7 | Certificate PDF generation performance | Low | Low | Generate async, store in Supabase Storage, serve pre-built PDF |

---

## Mobile Readiness Rules (Enforced Throughout)

| # | Rule | Enforcement |
|---|------|-------------|
| 1 | API routes for every mutation | Every server action in `lib/domains/*/mutations.ts` also exposed via `app/api/` |
| 2 | No business logic in components | Validation, calculations, grading in `lib/domains/*/utils.ts` only |
| 3 | Supabase queries in lib/ | All DB calls in `lib/domains/*/queries.ts`, not in page components |
| 4 | Types as the contract | All interfaces in `lib/types/` or `lib/domains/*/types.ts` |
| 5 | Auth via Supabase client | Design auth flows compatible with both `@supabase/ssr` and `@supabase/supabase-js` |

---

## Execution Tasks

### PHASE 1: Foundation & Infrastructure
_Estimated: ~40 tasks | Focus: Project setup, database, auth, base layouts_

#### 1A: Project Initialization

- [ ] **Task 1A.1**: Initialize Next.js 15 project with App Router, TypeScript, Tailwind CSS
  - Files: `package.json`, `next.config.ts`, `tailwind.config.ts`, `tsconfig.json`
  - Acceptance: `npm run dev` starts without errors

- [ ] **Task 1A.2**: Install and configure shadcn/ui
  - Files: `components.json`, `components/ui/*`
  - Acceptance: Can import and render shadcn components

- [ ] **Task 1A.3**: Install Supabase client libraries (`@supabase/supabase-js`, `@supabase/ssr`)
  - Files: `package.json`, `lib/supabase/client.ts`, `lib/supabase/server.ts`, `lib/supabase/middleware.ts`
  - Acceptance: Supabase client connects to project

- [ ] **Task 1A.4**: Create `.env.example` and `.env.local` with all required environment variables
  - Files: `.env.example`, `.env.local`
  - Vars: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `NEXT_PUBLIC_APP_URL`

- [ ] **Task 1A.5**: Configure `.gitignore` (node_modules, .env.local, .next, .mdmp reports)
  - Files: `.gitignore`

- [ ] **Task 1A.6**: Set up directory structure per project structure specification
  - Files: All directories created with placeholder `index.ts` exports
  - Acceptance: Directory tree matches spec

- [ ] **Task 1A.7**: Initialize git repository and create first commit
  - Acceptance: Clean git history with initial commit

- [ ] **Task 1A.8**: Link Vercel project under VetSecItPro team
  - Command: `vercel link --yes --scope team_HFUTBVxI8jKYi334LvgVsVNh`
  - Acceptance: `.vercel/project.json` has correct orgId

#### 1B: Database Schema & Migrations

- [ ] **Task 1B.1**: Create migration `00001_organizations.sql` — organizations table
  - Acceptance: Table created with correct columns, indexes

- [ ] **Task 1B.2**: Create migration `00002_profiles_and_roles.sql` — profiles, user_roles, user_role enum
  - Acceptance: Profiles linked to auth.users, roles enum works

- [ ] **Task 1B.3**: Create migration `00003_courses_modules_lessons.sql` — courses, modules, lessons, lesson_type enum
  - Acceptance: Full hierarchy with cascading deletes, sort_order columns

- [ ] **Task 1B.4**: Create migration `00004_cohorts_enrollments.sql` — cohorts, enrollments
  - Acceptance: Cohort references course, enrollment unique constraint works

- [ ] **Task 1B.5**: Create migration `00005_progress_tracking.sql` — lesson_completions, course_progress
  - Acceptance: Progress tracking tables with unique constraints

- [ ] **Task 1B.6**: Create migration `00006_quizzes.sql` — quizzes, quiz_questions, quiz_options, quiz_attempts, quiz_answers
  - Acceptance: Full quiz schema with question_type enum

- [ ] **Task 1B.7**: Create migration `00007_discussions.sql` — discussions, discussion_posts, post_reactions
  - Acceptance: Threaded replies via parent_post_id, unique reaction constraint

- [ ] **Task 1B.8**: Create migration `00008_announcements_notifications.sql` — announcements, notifications, notification_type enum
  - Acceptance: Notification types cover all events

- [ ] **Task 1B.9**: Create migration `00009_certificates.sql` — certificates table
  - Acceptance: Unique certificate_number generation

- [ ] **Task 1B.10**: Create migration `00010_external_integrations.sql` — external_platform_configs, external_enrollments, external_progress
  - Acceptance: Platform enum, unique constraints on enrollments

- [ ] **Task 1B.11**: Create migration `00011_file_library.sql` — course_files table
  - Acceptance: File metadata with storage_path

- [ ] **Task 1B.12**: Create migration `00012_rls_policies.sql` — RLS policies for ALL tables
  - Acceptance: Every table has SELECT/INSERT/UPDATE/DELETE policies based on role and organization_id

- [ ] **Task 1B.13**: Create migration `00013_seed_data.sql` — seed organization, admin user, sample course
  - Acceptance: Dev environment has usable test data

- [ ] **Task 1B.14**: Generate TypeScript types from schema
  - Files: `lib/supabase/database.types.ts`
  - Command: `supabase gen types typescript`

#### 1C: Authentication & Authorization

- [ ] **Task 1C.1**: Set up Supabase Auth with email/password sign-up and sign-in
  - Files: `lib/supabase/client.ts`, `lib/supabase/server.ts`
  - Acceptance: Can register and login via Supabase Auth

- [ ] **Task 1C.2**: Create Next.js middleware for auth session refresh and route protection
  - Files: `middleware.ts`
  - Acceptance: Unauthenticated users redirected to login; sessions refresh automatically

- [ ] **Task 1C.3**: Build auth trigger function — auto-create profile on user registration
  - Files: Migration SQL (Postgres trigger on auth.users insert)
  - Acceptance: New auth user automatically gets a profiles row

- [ ] **Task 1C.4**: Implement role-checking utility functions
  - Files: `lib/domains/admin/utils.ts`, `lib/types/auth.ts`
  - Acceptance: `hasRole(userId, 'admin')`, `requireRole('admin')` work correctly

- [ ] **Task 1C.5**: Create RBAC middleware for API routes
  - Files: `lib/supabase/middleware.ts` (API route wrappers)
  - Acceptance: API routes return 403 for unauthorized roles

- [ ] **Task 1C.6**: Build login page
  - Files: `app/(auth)/login/page.tsx`
  - Acceptance: Email/password login, error handling, redirect to dashboard

- [ ] **Task 1C.7**: Build registration page (admin-invited or self-register based on org settings)
  - Files: `app/(auth)/register/page.tsx`
  - Acceptance: Registration creates user + profile + student role

- [ ] **Task 1C.8**: Build forgot password page
  - Files: `app/(auth)/forgot-password/page.tsx`
  - Acceptance: Password reset email flow works

#### 1D: Base Layouts & Navigation

- [ ] **Task 1D.1**: Create root layout with providers (Supabase, theme)
  - Files: `app/layout.tsx`
  - Acceptance: Providers wrap all pages, auth state available

- [ ] **Task 1D.2**: Create student layout with top navigation bar and responsive sidebar
  - Files: `app/(student)/layout.tsx`, `components/layout/student-nav.tsx`, `components/layout/student-sidebar.tsx`
  - Acceptance: Nav shows Dashboard, My Courses, Community, Profile, Notifications

- [ ] **Task 1D.3**: Create admin layout with sidebar navigation
  - Files: `app/(admin)/layout.tsx`, `components/layout/admin-sidebar.tsx`
  - Acceptance: Sidebar shows Dashboard, Courses, Cohorts, Students, Integrations, Announcements, Discussions, Settings

- [ ] **Task 1D.4**: Create role-based redirect from root `/` to appropriate dashboard
  - Files: `app/page.tsx`, `middleware.ts`
  - Acceptance: Admin goes to /admin/dashboard, student goes to /dashboard

- [ ] **Task 1D.5**: Build shared loading, error, and not-found pages
  - Files: `app/loading.tsx`, `app/error.tsx`, `app/not-found.tsx`
  - Acceptance: Graceful handling of all states

---

### PHASE 2: Course Management (Admin Side)
_Estimated: ~25 tasks | Focus: Features 1-5 (Course Builder, Modules, Lessons, Templates, File Library)_

#### 2A: Course CRUD

- [ ] **Task 2A.1**: Build course domain types
  - Files: `lib/domains/courses/types.ts`
  - Acceptance: Course, Module, Lesson interfaces match DB schema

- [ ] **Task 2A.2**: Build course queries (list, get by ID, get by slug)
  - Files: `lib/domains/courses/queries.ts`
  - Acceptance: All queries use organization_id filter

- [ ] **Task 2A.3**: Build course mutations (create, update, delete, publish, archive)
  - Files: `lib/domains/courses/mutations.ts`
  - Acceptance: Status transitions enforced (draft → published → archived)

- [ ] **Task 2A.4**: Build course validation schemas (Zod)
  - Files: `lib/utils/validation.ts` (course schemas)
  - Acceptance: Title, description, category validated

- [ ] **Task 2A.5**: Build admin course list page with search, filter, status badges
  - Files: `app/(admin)/courses/page.tsx`, `components/admin/course-table.tsx`
  - Acceptance: Shows all courses with status, enrollment count, actions

- [ ] **Task 2A.6**: Build admin create course page (form with metadata, thumbnail upload)
  - Files: `app/(admin)/courses/new/page.tsx`, `components/courses/course-form.tsx`
  - Acceptance: Course created in draft status with all metadata

- [ ] **Task 2A.7**: Build admin edit course page
  - Files: `app/(admin)/courses/[courseId]/edit/page.tsx`
  - Acceptance: All fields editable, save updates DB

- [ ] **Task 2A.8**: Build course API routes (CRUD)
  - Files: `app/api/courses/route.ts`, `app/api/courses/[courseId]/route.ts`
  - Acceptance: Full REST API for courses (mobile-ready)

#### 2B: Module System

- [ ] **Task 2B.1**: Build module queries and mutations
  - Files: `lib/domains/courses/queries.ts` (module section), `lib/domains/courses/mutations.ts` (module section)
  - Acceptance: CRUD + reorder modules within a course

- [ ] **Task 2B.2**: Build module management UI with drag-and-drop ordering
  - Files: `app/(admin)/courses/[courseId]/modules/page.tsx`, `components/courses/module-list.tsx`
  - Acceptance: Add, edit, delete, reorder modules; changes persist

- [ ] **Task 2B.3**: Build module API routes
  - Files: `app/api/courses/[courseId]/modules/route.ts`
  - Acceptance: CRUD + reorder endpoints

#### 2C: Lesson Editor (Tiptap)

- [ ] **Task 2C.1**: Install and configure Tiptap with extensions (StarterKit, Image, Video, CodeBlock, Link, Table, Placeholder)
  - Files: `package.json`, `components/editor/tiptap-editor.tsx`, `components/editor/toolbar.tsx`
  - Acceptance: Rich text editor renders with formatting toolbar

- [ ] **Task 2C.2**: Build lesson queries and mutations
  - Files: `lib/domains/courses/queries.ts` (lesson section), `lib/domains/courses/mutations.ts`
  - Acceptance: CRUD lessons, content stored as Tiptap JSON

- [ ] **Task 2C.3**: Build admin lesson editor page with Tiptap, video embed, file attach
  - Files: `app/(admin)/courses/[courseId]/lessons/[lessonId]/edit/page.tsx`, `components/courses/lesson-editor.tsx`
  - Acceptance: Admin can create rich content with text, images, video, files

- [ ] **Task 2C.4**: Build Tiptap content renderer (read-only) for student view
  - Files: `components/courses/lesson-content.tsx`
  - Acceptance: Renders Tiptap JSON as formatted HTML safely (no XSS)

- [ ] **Task 2C.5**: Build lesson API routes
  - Files: `app/api/courses/[courseId]/modules/[moduleId]/lessons/route.ts`
  - Acceptance: CRUD + content save/load

#### 2D: File & Media Library

- [ ] **Task 2D.1**: Configure Supabase Storage buckets (course-files: private, thumbnails: public)
  - Acceptance: Buckets created with correct policies

- [ ] **Task 2D.2**: Build file upload component with drag-and-drop, progress, type validation
  - Files: `components/shared/file-upload.tsx`
  - Acceptance: Upload to Supabase Storage, restrict types (images, PDFs, docs), max 50MB

- [ ] **Task 2D.3**: Build file library page for admins
  - Files: `app/(admin)/courses/[courseId]/files/page.tsx` (or inline in course editor)
  - Acceptance: Browse, upload, delete files for a course

- [ ] **Task 2D.4**: Build file API routes (upload, list, delete)
  - Files: `app/api/files/route.ts`
  - Acceptance: Signed URL generation for private files

#### 2E: Course Templates & Cohort Cloning

- [ ] **Task 2E.1**: Build cohort domain types, queries, mutations
  - Files: `lib/domains/courses/types.ts` (cohort section), queries, mutations
  - Acceptance: Cohort CRUD with course association

- [ ] **Task 2E.2**: Build course cloning utility (deep copy course → modules → lessons for new cohort)
  - Files: `lib/domains/courses/utils.ts` (cloneCourse function)
  - Acceptance: All modules/lessons duplicated with new IDs, linked to new cohort

- [ ] **Task 2E.3**: Build admin cohort management pages (list, create/clone, detail)
  - Files: `app/(admin)/cohorts/page.tsx`, `app/(admin)/cohorts/new/page.tsx`, `app/(admin)/cohorts/[cohortId]/page.tsx`
  - Acceptance: Admin can clone a course for a new cohort, see all cohorts

- [ ] **Task 2E.4**: Build cohort API routes
  - Files: `app/api/cohorts/route.ts`, `app/api/cohorts/[cohortId]/route.ts`
  - Acceptance: CRUD + clone endpoint

---

### PHASE 3: Student Learning Experience
_Estimated: ~25 tasks | Focus: Features 6-10 (Dashboard, Course Player, Progress, Quizzes, Certificates)_

#### 3A: Student Dashboard

- [ ] **Task 3A.1**: Build student dashboard with enrolled courses grid, progress rings, recent activity
  - Files: `app/(student)/dashboard/page.tsx`, `components/courses/course-card.tsx`, `components/shared/progress-ring.tsx`
  - Acceptance: Shows all enrolled courses with progress percentage, last activity

- [ ] **Task 3A.2**: Build "continue learning" widget (last accessed lesson with one-click resume)
  - Files: `components/courses/continue-learning.tsx`
  - Acceptance: Takes student directly to their last lesson

- [ ] **Task 3A.3**: Build recent announcements widget on dashboard
  - Files: `components/shared/announcements-widget.tsx`
  - Acceptance: Shows latest 3 announcements with "view all" link

#### 3B: Course Player

- [ ] **Task 3B.1**: Build course overview page (description, module outline, progress, enroll button)
  - Files: `app/(student)/courses/[courseId]/page.tsx`, `components/courses/course-overview.tsx`
  - Acceptance: Shows course info, modules with lesson count, overall progress

- [ ] **Task 3B.2**: Build lesson player page with sidebar navigation, content area, completion button
  - Files: `app/(student)/courses/[courseId]/lessons/[lessonId]/page.tsx`, `components/courses/lesson-player.tsx`, `components/courses/lesson-sidebar.tsx`
  - Acceptance: Lesson content renders, sidebar shows all modules/lessons with completion status

- [ ] **Task 3B.3**: Build lesson navigation (previous/next) with auto-advance
  - Files: `components/courses/lesson-navigation.tsx`
  - Acceptance: Previous/Next buttons navigate lessons in order, module boundaries handled

- [ ] **Task 3B.4**: Build video lesson player (YouTube/Vimeo embed with responsive iframe)
  - Files: `components/courses/video-player.tsx`
  - Acceptance: Video embeds responsively, supports YouTube and Vimeo URLs

#### 3C: Progress Tracking

- [ ] **Task 3C.1**: Build progress domain types, queries, mutations
  - Files: `lib/domains/progress/types.ts`, `queries.ts`, `mutations.ts`
  - Acceptance: Mark lesson complete, calculate module/course progress

- [ ] **Task 3C.2**: Build progress calculation utility (lesson → module → course rollup)
  - Files: `lib/domains/progress/utils.ts`
  - Acceptance: Correctly computes percentage based on required lessons completed

- [ ] **Task 3C.3**: Implement "Mark as Complete" button on lesson player
  - Files: Update `components/courses/lesson-player.tsx`
  - Acceptance: Clicking marks lesson complete, updates sidebar checkmarks, recalculates progress

- [ ] **Task 3C.4**: Build progress API routes (mark complete, get progress)
  - Files: `app/api/progress/route.ts`
  - Acceptance: POST to mark complete, GET for user progress

- [ ] **Task 3C.5**: Build database trigger/function to update course_progress on lesson_completion insert
  - Files: Migration SQL
  - Acceptance: course_progress row auto-updates when lessons are completed

#### 3D: Quizzes & Assessments

- [ ] **Task 3D.1**: Build quiz domain types, queries, mutations, grading utils
  - Files: `lib/domains/quizzes/types.ts`, `queries.ts`, `mutations.ts`, `utils.ts`
  - Acceptance: Auto-grade multiple choice/T-F, manual flag for short answer

- [ ] **Task 3D.2**: Build quiz player component (question display, answer selection, submit)
  - Files: `components/quizzes/quiz-player.tsx`, `components/quizzes/question-card.tsx`
  - Acceptance: Student takes quiz, answers submitted, auto-graded, score shown

- [ ] **Task 3D.3**: Build quiz results view (score, correct answers, explanations)
  - Files: `components/quizzes/quiz-results.tsx`
  - Acceptance: Shows score, pass/fail, per-question results with explanations

- [ ] **Task 3D.4**: Build admin quiz builder (add questions, set options, mark correct answers)
  - Files: `components/quizzes/quiz-builder.tsx`, `components/quizzes/question-form.tsx`
  - Acceptance: Admin can create quiz with mixed question types, set passing score

- [ ] **Task 3D.5**: Build quiz API routes (start attempt, submit answers, get results)
  - Files: `app/api/quizzes/route.ts`, `app/api/quizzes/[quizId]/attempts/route.ts`
  - Acceptance: Full quiz lifecycle via API

#### 3E: Certificates of Completion

- [ ] **Task 3E.1**: Build certificate domain logic (generation, validation, unique numbering)
  - Files: `lib/domains/certificates/types.ts`, `mutations.ts`, `utils.ts`
  - Acceptance: Certificate auto-generated when course completed, unique number assigned

- [ ] **Task 3E.2**: Build certificate PDF template and generation (using @react-pdf/renderer or similar)
  - Files: `components/certificates/certificate-template.tsx`, `lib/domains/certificates/generate.ts`
  - Acceptance: Branded PDF with student name, course title, date, certificate number

- [ ] **Task 3E.3**: Build certificate view/download page for students
  - Files: `app/(student)/certificates/[certId]/page.tsx`
  - Acceptance: Student can view and download their certificate

- [ ] **Task 3E.4**: Build certificate API routes (generate, verify, download)
  - Files: `app/api/certificates/route.ts`
  - Acceptance: Generate on completion, verify by certificate number

---

### PHASE 4: Community & Communication
_Estimated: ~20 tasks | Focus: Features 11-14 (Discussions, Announcements, Profiles, Notifications)_

#### 4A: Discussion Boards

- [ ] **Task 4A.1**: Build community domain types, queries, mutations
  - Files: `lib/domains/community/types.ts`, `queries.ts`, `mutations.ts`
  - Acceptance: Discussion CRUD, post CRUD, reaction toggle

- [ ] **Task 4A.2**: Build discussion list page (all discussions, filter by cohort, search)
  - Files: `app/(student)/community/page.tsx`, `components/community/discussion-list.tsx`
  - Acceptance: Shows discussions with reply count, last activity, author

- [ ] **Task 4A.3**: Build discussion thread page (OP + threaded replies, rich text)
  - Files: `app/(student)/community/[threadId]/page.tsx`, `components/community/thread-view.tsx`, `components/community/post-card.tsx`
  - Acceptance: Threaded replies, upvotes, pin/lock indicators

- [ ] **Task 4A.4**: Build new discussion form and reply form (with Tiptap)
  - Files: `components/community/new-discussion-form.tsx`, `components/community/reply-form.tsx`
  - Acceptance: Rich text posts, submit creates discussion/reply

- [ ] **Task 4A.5**: Build upvote/reaction functionality with optimistic UI
  - Files: `components/community/reaction-button.tsx`
  - Acceptance: Click toggles upvote, count updates immediately

- [ ] **Task 4A.6**: Set up Supabase Realtime subscription for new posts/replies
  - Files: Update discussion components with realtime listeners
  - Acceptance: New replies appear without page refresh

- [ ] **Task 4A.7**: Build discussion API routes
  - Files: `app/api/discussions/route.ts`, `app/api/discussions/[threadId]/posts/route.ts`
  - Acceptance: Full CRUD + reactions via API

#### 4B: Announcements

- [ ] **Task 4B.1**: Build announcement queries and mutations
  - Files: `lib/domains/notifications/` (announcement section)
  - Acceptance: Create, publish, list announcements filtered by org/cohort

- [ ] **Task 4B.2**: Build admin announcement management pages (list, create, edit)
  - Files: `app/(admin)/announcements/page.tsx`, `app/(admin)/announcements/new/page.tsx`
  - Acceptance: Admin creates announcement with Tiptap editor, publishes to cohort or org-wide

- [ ] **Task 4B.3**: Build student announcements view (list + detail)
  - Files: `app/(student)/announcements/page.tsx` (or integrated into dashboard)
  - Acceptance: Students see relevant announcements sorted by date

- [ ] **Task 4B.4**: Trigger notifications when announcement published
  - Files: DB trigger or server-side logic
  - Acceptance: All students in target cohort/org receive notification

#### 4C: Student Profiles

- [ ] **Task 4C.1**: Build profile edit page (bio, avatar upload, timezone, settings)
  - Files: `app/(student)/profile/page.tsx`, `components/shared/profile-form.tsx`
  - Acceptance: Students can update their profile, upload avatar

- [ ] **Task 4C.2**: Build public profile view (bio, enrolled courses, achievements, activity)
  - Files: `app/(student)/profile/[userId]/page.tsx`, `components/shared/profile-card.tsx`
  - Acceptance: View other students' profiles within same org

- [ ] **Task 4C.3**: Build profile API routes
  - Files: `app/api/profiles/route.ts`
  - Acceptance: GET/PUT profile data

#### 4D: Notification Center

- [ ] **Task 4D.1**: Build notification queries and mutations
  - Files: `lib/domains/notifications/types.ts`, `queries.ts`, `mutations.ts`
  - Acceptance: List unread, mark read, mark all read

- [ ] **Task 4D.2**: Build notification bell icon with unread count badge
  - Files: `components/layout/notification-bell.tsx`
  - Acceptance: Shows count, updates in real-time via Supabase Realtime

- [ ] **Task 4D.3**: Build notification dropdown/page with notification list
  - Files: `app/(student)/notifications/page.tsx`, `components/shared/notification-list.tsx`
  - Acceptance: List notifications, click navigates to relevant page, marks as read

- [ ] **Task 4D.4**: Build notification API routes
  - Files: `app/api/notifications/route.ts`
  - Acceptance: List, mark read, mark all read

- [ ] **Task 4D.5**: Create notification trigger functions for key events (reply, announcement, quiz grade, enrollment, completion)
  - Files: DB triggers or server-side logic in mutations
  - Acceptance: Notifications auto-created for all notification_type events

---

### PHASE 5: Admin Dashboard & Analytics
_Estimated: ~20 tasks | Focus: Features 15-18 (Admin Dashboard, Student Management, External Integration, RBAC)_

#### 5A: Admin Analytics Dashboard

- [ ] **Task 5A.1**: Build admin analytics queries (enrollment stats, completion rates, active users, engagement trends)
  - Files: `lib/domains/admin/queries.ts`
  - Acceptance: Aggregate queries return correct metrics

- [ ] **Task 5A.2**: Build admin dashboard page with stat cards, charts, recent activity
  - Files: `app/(admin)/dashboard/page.tsx`, `components/admin/stat-card.tsx`, `components/admin/charts/`
  - Acceptance: Shows total students, active enrollments, completion rates, engagement over time

- [ ] **Task 5A.3**: Build course analytics view (per-course completion rates, drop-off points, avg quiz scores)
  - Files: `components/admin/course-analytics.tsx`
  - Acceptance: Admin can see which modules/lessons have lowest completion

- [ ] **Task 5A.4**: Build student progress overview table (all students, all courses, completion %)
  - Files: `components/admin/student-progress-table.tsx`
  - Acceptance: Sortable, filterable table with progress bars per student per course

#### 5B: Student Management

- [ ] **Task 5B.1**: Build admin student roster page with search, filter by cohort, status badges
  - Files: `app/(admin)/students/page.tsx`, `components/admin/student-table.tsx`
  - Acceptance: Full student list with enrollment status, progress, last activity

- [ ] **Task 5B.2**: Build admin add student page (single add with role assignment)
  - Files: `app/(admin)/students/new/page.tsx`
  - Acceptance: Admin creates student account, assigns to organization, sends invite email

- [ ] **Task 5B.3**: Build bulk enrollment (CSV import: name, email, cohort)
  - Files: `components/admin/bulk-enroll.tsx`, `app/api/students/bulk/route.ts`
  - Acceptance: Upload CSV, validate, create accounts, enroll in cohort

- [ ] **Task 5B.4**: Build student detail page (profile, all enrollments, progress across courses, external progress)
  - Files: `app/(admin)/students/[studentId]/page.tsx`
  - Acceptance: Admin sees complete student picture — internal + external progress

- [ ] **Task 5B.5**: Build enrollment management (enroll/unenroll students from cohorts)
  - Files: `app/(admin)/cohorts/[cohortId]/page.tsx` (enrollment section)
  - Acceptance: Add/remove students from cohort, status changes

- [ ] **Task 5B.6**: Build student management API routes
  - Files: `app/api/students/route.ts`, `app/api/students/[studentId]/route.ts`, `app/api/students/bulk/route.ts`
  - Acceptance: Full CRUD + bulk operations

#### 5C: External Platform Integration

- [ ] **Task 5C.1**: Build integration adapter interface and base types
  - Files: `lib/domains/integrations/types.ts`, `lib/domains/integrations/adapter.ts`
  - Acceptance: Generic interface that Coursera/Pluralsight/Udemy adapters implement

- [ ] **Task 5C.2**: Build Coursera adapter (OAuth2 auth, enrollment fetch, progress fetch)
  - Files: `lib/domains/integrations/coursera/client.ts`, `adapter.ts`, `types.ts`
  - Acceptance: Connects to Coursera API, pulls enrollment and progress data

- [ ] **Task 5C.3**: Build Pluralsight adapter (API key auth, GraphQL queries for ContentProgress)
  - Files: `lib/domains/integrations/pluralsight/client.ts`, `adapter.ts`, `types.ts`
  - Acceptance: Connects to Pluralsight GraphQL API, pulls progress data

- [ ] **Task 5C.4**: Build Udemy adapter (Basic auth, REST endpoints for user-progress)
  - Files: `lib/domains/integrations/udemy/client.ts`, `adapter.ts`, `types.ts`
  - Acceptance: Connects to Udemy Business API, pulls progress data

- [ ] **Task 5C.5**: Build integration sync engine (scheduled sync, error handling, last-synced tracking)
  - Files: `lib/domains/integrations/sync.ts`, `app/api/integrations/sync/route.ts`
  - Acceptance: Cron-triggered sync pulls latest data from all enabled platforms

- [ ] **Task 5C.6**: Build admin integration configuration page (enable/disable platforms, enter credentials, trigger manual sync)
  - Files: `app/(admin)/integrations/page.tsx`, `components/admin/integration-config.tsx`
  - Acceptance: Admin can configure each platform, see sync status, trigger manual sync

- [ ] **Task 5C.7**: Build unified external progress view (all platforms, all students, in one table)
  - Files: `components/admin/external-progress-table.tsx`
  - Acceptance: Single table showing student progress across Coursera + Pluralsight + Udemy

- [ ] **Task 5C.8**: Build integration API routes
  - Files: `app/api/integrations/route.ts`, `app/api/integrations/sync/route.ts`
  - Acceptance: Configure, sync, and query external progress via API

#### 5D: Role-Based Access Control

- [ ] **Task 5D.1**: Build admin user role management (assign/revoke roles)
  - Files: `app/(admin)/settings/page.tsx` (roles section), `components/admin/role-manager.tsx`
  - Acceptance: Admin can promote student to instructor, assign admin role

- [ ] **Task 5D.2**: Build instructor-specific permissions (can manage own courses, grade quizzes, moderate discussions)
  - Files: Update RLS policies, middleware checks
  - Acceptance: Instructors have limited admin access scoped to their courses

- [ ] **Task 5D.3**: Build admin discussion moderation page (pin, lock, delete posts)
  - Files: `app/(admin)/discussions/page.tsx`
  - Acceptance: Admin/instructor can moderate community content

---

### PHASE 6: Polish & Responsive Design
_Estimated: ~15 tasks | Focus: Features 19-20 (Auth polish, Responsive Design) + UX polish_

#### 6A: Responsive Design

- [ ] **Task 6A.1**: Audit and fix all student pages for mobile responsiveness
  - Acceptance: Dashboard, course player, discussions, profile work on 375px+ screens

- [ ] **Task 6A.2**: Build mobile-specific navigation (hamburger menu, bottom nav)
  - Files: `components/layout/mobile-nav.tsx`
  - Acceptance: Touch-friendly navigation on mobile

- [ ] **Task 6A.3**: Make course player mobile-friendly (collapsible sidebar, full-width content)
  - Acceptance: Lesson content readable on phone, sidebar toggles as drawer

- [ ] **Task 6A.4**: Make admin dashboard responsive (stacking cards, scrollable tables)
  - Acceptance: Admin can manage courses from tablet

- [ ] **Task 6A.5**: Make quiz player touch-friendly
  - Acceptance: Answer selection works well on touch devices

#### 6B: UX Polish

- [ ] **Task 6B.1**: Build empty state components for all list pages (no courses, no discussions, no notifications)
  - Files: `components/shared/empty-state.tsx`
  - Acceptance: Every empty list shows helpful message + CTA

- [ ] **Task 6B.2**: Build skeleton loading states for all major components
  - Files: `components/shared/skeletons/`
  - Acceptance: Content shimmer while loading, no layout shift

- [ ] **Task 6B.3**: Build error boundary components with retry
  - Files: `components/shared/error-boundary.tsx`
  - Acceptance: Errors caught gracefully with "Try Again" button

- [ ] **Task 6B.4**: Build toast notification system for success/error feedback
  - Files: `components/shared/toast.tsx` (or use shadcn/ui toast)
  - Acceptance: Actions show success/error toast

- [ ] **Task 6B.5**: Build confirmation dialogs for destructive actions (delete course, remove student, etc.)
  - Files: `components/shared/confirm-dialog.tsx`
  - Acceptance: All destructive actions require confirmation

- [ ] **Task 6B.6**: Add keyboard shortcuts for common actions (Cmd+K search, Esc to close)
  - Files: `components/shared/command-palette.tsx`
  - Acceptance: Cmd+K opens search/command palette

#### 6C: Search

- [ ] **Task 6C.1**: Build global search (courses, students, discussions)
  - Files: `components/shared/global-search.tsx`, `app/api/search/route.ts`
  - Acceptance: Type-ahead search across main entities

---

### PHASE 7: Testing & Security Validation
_Estimated: ~15 tasks | Focus: Tests, security audit, performance_

#### 7A: Unit Tests

- [ ] **Task 7A.1**: Write unit tests for progress calculation utils
  - Acceptance: All edge cases covered (0%, 100%, partial, no required lessons)

- [ ] **Task 7A.2**: Write unit tests for quiz grading utils
  - Acceptance: Multiple choice, T/F, scoring, pass/fail logic verified

- [ ] **Task 7A.3**: Write unit tests for certificate generation utils
  - Acceptance: Certificate number uniqueness, metadata correctness

- [ ] **Task 7A.4**: Write unit tests for course cloning utils
  - Acceptance: Deep copy verified, new IDs generated, relationships preserved

#### 7B: Integration Tests

- [ ] **Task 7B.1**: Write RLS policy tests (attempt cross-org data access, cross-student data access)
  - Acceptance: All unauthorized access returns empty/forbidden

- [ ] **Task 7B.2**: Write API route integration tests for course CRUD
  - Acceptance: Create, read, update, delete work with proper auth

- [ ] **Task 7B.3**: Write API route integration tests for enrollment + progress
  - Acceptance: Enroll, complete lesson, check progress, all verified

- [ ] **Task 7B.4**: Write external integration adapter tests with mocked APIs
  - Acceptance: Coursera, Pluralsight, Udemy adapters handle success and error responses

#### 7C: E2E Tests

- [ ] **Task 7C.1**: E2E: Student login → dashboard → start course → complete lesson → view progress
  - Acceptance: Full student learning flow works end-to-end

- [ ] **Task 7C.2**: E2E: Admin login → create course → add modules/lessons → publish → create cohort → enroll student
  - Acceptance: Full admin course creation flow works

- [ ] **Task 7C.3**: E2E: Student posts discussion → another student replies → upvotes
  - Acceptance: Community flow works end-to-end

#### 7D: Security & Performance

- [ ] **Task 7D.1**: Security audit — verify all RLS policies, API route auth checks, input validation
  - Acceptance: No unauthorized data access possible

- [ ] **Task 7D.2**: Performance audit — check N+1 queries, add indexes, optimize slow queries
  - Acceptance: All pages load in < 2 seconds on standard connection

- [ ] **Task 7D.3**: Verify Tiptap content rendering is XSS-safe
  - Acceptance: No raw HTML injection possible through lesson content or discussion posts

---

## Rollback Plan

If critical issues are discovered post-deployment:

1. Vercel instant rollback to previous deployment
2. Supabase migration rollback scripts (reverse each migration)
3. Database backup restoration from Supabase daily backups
4. Feature-specific disable via organization settings JSON

---

## Integration Points

After completion, consider:
- [ ] `/gh-ship` — Commit, push, PR, deploy
- [ ] `/sec-ship` — Security validation
- [ ] `/deps` — Dependency health check
- [ ] `/perf` — Performance audit
- [ ] `/a11y` — Accessibility audit

---

## Execution Strategy

This is a multi-session build. Each phase is a focused sprint:

| Phase | Sessions | Dependencies |
|-------|:---:|---|
| Phase 1: Foundation | 2-3 | None (start here) |
| Phase 2: Course Management | 2-3 | Phase 1 complete |
| Phase 3: Student Experience | 2-3 | Phase 2 (courses exist to display) |
| Phase 4: Community | 1-2 | Phase 1 (auth + layouts) |
| Phase 5: Admin + Integrations | 2-3 | Phase 2 + 3 (data exists to analyze) |
| Phase 6: Polish | 1-2 | All features complete |
| Phase 7: Testing | 1-2 | All features complete |

**Note:** Phases 4 and 2-3 have some parallelism potential. Community features only need auth and layouts (Phase 1), not course management.

---

## Execution Log

| Time | Action | Result |
|------|--------|--------|
| 2026-02-10 14:00 | MDMP Orders created | Planning complete |

---

## SITREP

**Status:** PLANNING COMPLETE — AWAITING PHASE 1 EXECUTION

**Total Tasks:** ~160 across 7 phases
**Total Features:** 20

**Files to Create:** ~80+ source files + 13 migrations
**Estimated Tables:** 18 + RLS policies

**Recommended First Action:** Begin Phase 1A (Project Initialization) — `Task 1A.1` through `Task 1A.8`
